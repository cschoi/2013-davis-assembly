================
PacBio tutorials
================

Smrtportal AMI
-------------------

Smrtportal/smrtanalysis is the software developed by Pacific Biosciences

* start a new amazon instance (as before, m1.xlarge)
* follow the instructions for setting up the smrtportal AMI from `this pdf <https://s3.amazonaws.com/files.pacb.com/software/smrtanalysis/2.1.0/Doc/Running%20SMRT%20Analysis%20on%20Amazon.pdf>`__
* **NOTE** skip the filezilla step

Downloading data
-------------------

We'll use data from a single smrtcell based on a size selected 20kb *E. coli* library

Do::

  cd /opt/smrtanalysis/common/inputs_dropbox
  wget http://sourceforge.net/projects/fuse/files/fuse-2.X/2.8.4/fuse-2.8.4.tar.gz
  tar -vxzf ecoliK12.tar.gz

To import into smrtportal:

* in smrtportal, go to Home --> Import and Manage --> Import SMRT Cells
* click on common/inputs_dropbox
* click 'Scan' and OK

HGAP for assembly
-------------------

* in smrtportal, go to Home --> Create New
* add your imported smrtcell by selecting it and clicking the triangle pointing to the right
* give your job a name
* for protocol, select RS_HGAP_Assembly.2 (*not* '.1')
* click 'Save'
* click 'Start'

Monitor the run, it will probably go overnight

**Where is the data**

Check /opt/smrtanalysis/common/jobs/016/016XXX, where 016XXX is the job ID from smrtportal.  
Results appear in the *data* folder

Base modification detection
---------------------------

Use:

* the same smrtcell data
* the RS_Modification_and_Motif_Analysis.1 protocol
* the 'e coli K12 MG1655' reference from the dropdown menu

Running smrtanalysis from the commandline
-----------------------------------------

See this part of the Pacific Biosciences wiki: https://github.com/PacificBiosciences/SMRT-Analysis/wiki/SMRT-Pipe-Reference-Guide-v2.0#-using-the-command-line

* You'll need a settings xml file, which can only be obtained by setting up a smrtportal job with the correct protocol, and grabbing the settings.xml from /opt/smrtanalysis/common/jobs/016/016XXX, where 016XXX is the job ID from smrtportal
* You'll also need an input.fofn file ('file-of-filenames', which contains the full path to the bax.h5 (or bas.h5) file(s)

Do::

  . /opt/smrtanalysis/etc/setup.sh
  fofnToSmrtpipeInput.py input.fofn > input.xml
  smrtpipe.py --params=settings.xml xml:input.xml

Or customise smrtpipe to use more cpus (if available)::

  smrtpipe.py -D NPROC=24 --params=settings.xml xml:input.xml

Results appear in the *data* folder

Running blasr to map reads
--------------------------

* upload the reference (e.g., the velvet assembly we used for QC/Validation)
* We will run blasr on a subset of the reads (using only one of the three bax.h5 files)
* samtools is included in the smrtportal distribution

Do::

  . /opt/smrtanalysis/etc/setup.sh
  blasr /opt/smrtanalysis/common/inputs_dropbox/ecoliK12/Analysis_Results/m130404_014004_sidney_c100506902550000001823076808221337_s1_p0.2.bax.h5 \
  /path/to/velvet_pe+mp.fa \
  -minSubreadLength 1000 -bestn 1 -nproc 4 -sam -out pacbio_2_velvet_pe+mp_71.sam
  
  samtools view -buS pacbio_2_velvet_pe+mp_71.sam | samtools sort - pacbio_2_velvet_pe+mp_71.sorted
  samtools index pacbio_2_velvet_pe+mp_71.sorted

